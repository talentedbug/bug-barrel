---
date: '2024-12-22T15:18:47+08:00'
draft: false
title: '在命令行对图片进行压缩'
typora-copy-images-to: '../../static/img/${filename}.d'
---

本蛾子在上一则博客中提到爬虫获取秀人网图片，事实上这段时间一直都在后台下载。但是最近一段时间发现，才下载 1000 套左右的图片，用作香橙派存储的 SD 卡（32 GiB）就已经快填满了。本文就来说说本蛾子如何在最大程度保留图片信息的前提下，尽量将图片进行压缩。

在我们的情况下，无损压缩是不起作用的。这些高分辨率的图片在上传到服务器的时候，为了节省流量，已经在无损的情况下将提及压缩到了最小。因此只能选择有损压缩。

有损压缩主要有两种方法：缩小尺寸和减少颜色。前者很好理解，就是将邻近的几个像素合并为一个最接近其混合起来的颜色的像素；后者则是将原本 2048 色甚至 4096 色这样色泽丰富的图片缩小到最接近的 256 色等比较少的颜色数量。

对应的，我们可以使用以下工具：

- `jpegoptim`：压缩色彩深度，`jpegoptim example.jpg -m[quality] -q` 表示将 `example.jpg` 的色彩深度压缩至 `[quality]`%。
- `imagemagick` 的 `convert` 指令：缩小图片，`convert -resize [pc]% example.jpg example.jpg` 表示将 `example.jpg` 的大小缩小为原来的 `[pc]`%。

那么，为了保持图片质量和节约存储空间的平衡，就需要找到一个平衡点。

## 🎨 压缩色彩深度

本蛾子使用秀人网上第一张图片作为测试。原图占用空间 284 KiB，显示效果：

![](../../static/img/f154239bd5.d/13.jpg)

我们先单独进行尺寸调整和色彩调整。

命令 `jpegoptim -m40 example.jpg --stdout > example-m40.jpg`，图片大小 139 KiB，显示效果：

![](../../static/img/f154239bd5.d/13-m40.jpg)

降低色彩深度到 40% 肉眼几乎看不出区别，但是如果放大一点，对比来看就会发现，墙壁后面的光晕模糊了，说明部分边缘处的像素被合并。

极端一点，对比就很明显了。命令 `jpegoptim -m5 example.jpg --stdout > example-m5.jpg`，图片大小 41 KiB。

![](../../static/img/f154239bd5.d/13-m5.jpg)

虽然这张图片的色彩深度降低很多，但是像素数量没有变化，因此右下角的文字仍然比较清晰，但是当然了，颜色这块就不忍直视了。

用降低色彩深度的方法压缩图片，最小的体积大概就是 40 KiB 左右了，由于像素数量没有改变，这个方法是有极限的。

但是，实际上我们的图片在网页里缩放展示，并不需要很大的图片尺寸（在本蛾子的浏览器，显示尺寸是 200x300）。因此，我们还可以用改变图片尺寸的方法来压缩图像。

## ✂️ 缩小图片尺寸

命令 `convert -resize 50% example.jpg example-rs50.jpg`，图片大小 103 KiB，显示效果：

![](../../static/img/f154239bd5.d/13-rs50.jpg)

缩小一半的图片就有肉眼可见的边缘模糊了，文字变模糊了。但是体积缩小也很立竿见影，在浏览器内显示，只要不看原图其实效果都不错。进一步缩小的结果本蛾子就不在这里放了，这个大家应该是清楚的。

## ☕ 解决方案：混合

本蛾子的那个爬虫总共下载 3300 多套图片，每套大概 60 到 80 张，总共 23 万张图片。那么，按照以上两种方案，分别需要：

- 色彩深度：$230000\times150\div1024\div1024=32.9$（单位 GiB）。
- 图片尺寸：$230000\times100\div1024\div1024=21.9$。

很容易想到一个方法，就是先压缩色彩深度，再修改图片尺寸。上面我么可以看到，修改色彩深度为 40% 质量时损失几乎肉眼不可见，而修改尺寸，本蛾子尝试了一下，似乎 50% 是比较适中的。那么就综合一下上面的命令。

图片大小 51 KiB，显示效果：

![](../../static/img/f154239bd5.d/13-m40-rs50.jpg)

导致显示效果降低的主要是缩放大小。

这次的图像总大小就降低到了 10 GiB，本蛾子的香橙派可以存两次了！如果存储空间还是紧张，可以进一步缩小图片尺寸，主要影响的是清晰度而非色彩，因此不会出现上面 `-m5` 那种怪异的画面。

新版本的代码，加上了两次的压缩，依然在 [talentedbug/dl_xiuren](https://github.com/talentedbug/dl_xiuren) 里，另外加入了适用于次元岛的爬虫。有兴趣的同学可以看看。
