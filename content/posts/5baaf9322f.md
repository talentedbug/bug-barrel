---
date: '2024-12-15T16:50:12+08:00'
draft: false
title: '使用 SSH 公鑰登錄服務器並禁用密碼'
typora-copy-images-to: '../../static/img/${filename}.d'
---

😠 **太長不讀**：生成 SSH密鑰，上傳到服務器，然後禁用密碼登錄。（好像是廢話）

## 0x01 🔒 生成 SSH 密鑰

> 以下使用 `$` 符號代表本機執行，`>` 符號代表服務器執行。

```
$ ssh-keygen # 舊版本需要添加 `-t ed25519` 參數
Generating public/private ed25519 key pair.
Enter file in which to save the key (/home/YOUR_USER_NAME/.ssh/id_ed25519): # 可以自定義位置，也可以直接回車
Enter passphrase for "example" (empty for no passphrase): # 輸入密碼（不顯示），不建議空密碼
Enter same passphrase again: # 再輸一遍
Your identification has been saved in id_ed25519
Your public key has been saved in id_ed25519.pub # 帶有 .pub 的是公鑰
The key fingerprint is:
SHA256:SOME_STRANGE_STRING YOUR_USER_NAME@YOUR_HOST_NAME # 你的公鑰指紋
The key's randomart image is: # 根據公鑰生成的隨機圖像
+--[ED25519 256]--+
|       SOME      |
|     STRANGE     |
|      IMAGE      |
|                 |
|                 |
|                 |
|                 |
|                 |
|                 |
+----[SHA256]-----+

$ ls .ssh
id_ed25519 id_ed25519 # 可能還有其他文件
```

## 0x02 ⬆️ 上傳到服務器

首先確保你當前可以使用密碼登錄一個**非 root** 的賬號。

```
$ ssh example_user@example_host
example_user@example_host's password: 
>
```

然後，退出 SSH，在本機上執行（注意是本機）：

```
$ ssh-copy-id -i .ssh/id_ed25519.pub example_user@example_host
```

在上傳過程中，會要求你輸入當前密碼。一般來說很快就會上傳完成。

測試一下是否可以登錄。

```
$ ssh -i .ssh/id_ed25519.pub example_user@example_host
.ssh/id_ed25519.pub's password: # 注意這裏變成輸入密鑰的密碼了
>
```

如果可以，繼續下一步。

## 0x03 🙅‍♂️ 禁用密碼登錄

```
> sudo vim /etc/ssh/sshd_config
```

在編輯器中，添加或修改以下選項：

```
PasswordAuthentication no
PermitRootLogin no
AllowPAM no
AllowUsers example_user # 可選，這將禁止除 example_user 之外任何用戶 SSH 登錄
```

保存並退出，然後：

```
> sudo systemctl restart sshd
```

退出 SSH，再次嘗試登錄：

```
$ ssh example_user@example_host
example_user@example_host: Permission denied (publickey).
```

再次使用密鑰登錄，如果登錄成功，那麼說明以上步驟都是正確的！

> ❓ 如果不行呢？恭喜你 🎉 你被鎖在系統之外了！VNC 你的服務器吧……
>
> ![Security Holes](../../static/img/5baaf9322f.d/security_holes.png)
>
> 來源：[XKCD](https://xkcd.com/424/)，原文解說是 *True story: I had to try several times to upload this comic because my ssh key was blacklisted.*。

