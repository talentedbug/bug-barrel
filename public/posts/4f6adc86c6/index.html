<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>搭建自己的代理服务器 | 桶装幺蛾子</title>
<meta name="keywords" content="">
<meta name="description" content="😡 太长不读版：使用 VLESS &#43; WebSocket &#43; TLS 方案、Cloudflare CDN 保护、Cloudflare WARP 解锁服务，在 RackNerd 的 10.99/yr 起廉价服务器上搭建一个安全、隐私、不易封的代理服务器。无广告，很详细。如果您已经下定决心要自己搭建，请跳过 0x01 和 0x02 节。

本文如未特殊提及，货币单位均为美元。好吧，其实是会被 KaTeX 识别成数学公式……

各位想必都已经混迹互联网十余载，对于这门技术有所耳闻，甚至自己购买过机场的订阅，在外面的世界已经遨游过一番了。今天本蛾子就讲一个老生常谈的问题：老是觉得那些机场主都不可靠，我能不能自己搭一个？
首先在文章开始之前，国际惯例，对于几个常见误解进行声明：

本蛾子热爱中华人民共和国，热爱中国共产党，绝无污蔑、诋毁国家、党和人民的行为，本文的目的仅仅是技术分享，读者您的行为的后果由您自行承担；
本蛾子没有收一分钱；相反，还因为购买服务器和域名花了 30 多，本文请放心食用；
搭建代理服务器是一个比较复杂的过程，您应当有最基本的 Linux 使用能力，对网络相关知识有一定了解；
无论是自建的代理还是机场，总有被封或跑路的一天，您的钱若打了水漂，本蛾子不负责。


12 月 28 日更新：删去了大段大段没啥用的安全性分析。

👌 我知道了，开始吧
准备好了？让我们先看看大概要做什么。

购买 RackNerd 服务器（0x04 节）；
购买 Namesilo 域名并用 Cloudflare 托管（0x04 节）；
服务器初步设置，对于建站比较通用（0x05 节）；
搭建代理服务器，此时您已经可以使用代理了（0x05 节）；
（可选）使用 Cloudflare 的 CDN 和 WARP 服务，对服务器前后流量进行优化（0x06 节）；
（可选）安全性和速度提升（0x06 节）。

本蛾子趁着双十一购买了服务器和域名，总价 27.86（¥200.87，按照支付宝和 Stripe 的汇率），如果您不幸地在没什么活动的时候看到这篇文章，也可以选择到 RackNerd 社区去找找优惠，下面会说到。如果没有什么意外（不可能），搭建时间会在 30 到 40 分钟。">
<meta name="author" content="智慧的幺蛾子">
<link rel="canonical" href="http://localhost:1313/posts/4f6adc86c6/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.75cc0bc8b7e49d1131c6aa01c8e0ffc243167dd94130253a953494bccdeba2cb.css" integrity="sha256-dcwLyLfknRExxqoByOD/wkMWfdlBMCU6lTSUvM3ross=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon.jpg">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon.jpg">
<link rel="mask-icon" href="http://localhost:1313/favicon.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh-cn" href="http://localhost:1313/posts/4f6adc86c6/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://localhost:1313/posts/4f6adc86c6/">
  <meta property="og:site_name" content="桶装幺蛾子">
  <meta property="og:title" content="搭建自己的代理服务器">
  <meta property="og:description" content="😡 太长不读版：使用 VLESS &#43; WebSocket &#43; TLS 方案、Cloudflare CDN 保护、Cloudflare WARP 解锁服务，在 RackNerd 的 10.99/yr 起廉价服务器上搭建一个安全、隐私、不易封的代理服务器。无广告，很详细。如果您已经下定决心要自己搭建，请跳过 0x01 和 0x02 节。
本文如未特殊提及，货币单位均为美元。好吧，其实是会被 KaTeX 识别成数学公式……
各位想必都已经混迹互联网十余载，对于这门技术有所耳闻，甚至自己购买过机场的订阅，在外面的世界已经遨游过一番了。今天本蛾子就讲一个老生常谈的问题：老是觉得那些机场主都不可靠，我能不能自己搭一个？
首先在文章开始之前，国际惯例，对于几个常见误解进行声明：
本蛾子热爱中华人民共和国，热爱中国共产党，绝无污蔑、诋毁国家、党和人民的行为，本文的目的仅仅是技术分享，读者您的行为的后果由您自行承担； 本蛾子没有收一分钱；相反，还因为购买服务器和域名花了 30 多，本文请放心食用； 搭建代理服务器是一个比较复杂的过程，您应当有最基本的 Linux 使用能力，对网络相关知识有一定了解； 无论是自建的代理还是机场，总有被封或跑路的一天，您的钱若打了水漂，本蛾子不负责。 12 月 28 日更新：删去了大段大段没啥用的安全性分析。
👌 我知道了，开始吧 准备好了？让我们先看看大概要做什么。
购买 RackNerd 服务器（0x04 节）； 购买 Namesilo 域名并用 Cloudflare 托管（0x04 节）； 服务器初步设置，对于建站比较通用（0x05 节）； 搭建代理服务器，此时您已经可以使用代理了（0x05 节）； （可选）使用 Cloudflare 的 CDN 和 WARP 服务，对服务器前后流量进行优化（0x06 节）； （可选）安全性和速度提升（0x06 节）。 本蛾子趁着双十一购买了服务器和域名，总价 27.86（¥200.87，按照支付宝和 Stripe 的汇率），如果您不幸地在没什么活动的时候看到这篇文章，也可以选择到 RackNerd 社区去找找优惠，下面会说到。如果没有什么意外（不可能），搭建时间会在 30 到 40 分钟。">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-11-17T00:00:00+08:00">
    <meta property="article:modified_time" content="2024-11-17T00:00:00+08:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搭建自己的代理服务器">
<meta name="twitter:description" content="😡 太长不读版：使用 VLESS &#43; WebSocket &#43; TLS 方案、Cloudflare CDN 保护、Cloudflare WARP 解锁服务，在 RackNerd 的 10.99/yr 起廉价服务器上搭建一个安全、隐私、不易封的代理服务器。无广告，很详细。如果您已经下定决心要自己搭建，请跳过 0x01 和 0x02 节。

本文如未特殊提及，货币单位均为美元。好吧，其实是会被 KaTeX 识别成数学公式……

各位想必都已经混迹互联网十余载，对于这门技术有所耳闻，甚至自己购买过机场的订阅，在外面的世界已经遨游过一番了。今天本蛾子就讲一个老生常谈的问题：老是觉得那些机场主都不可靠，我能不能自己搭一个？
首先在文章开始之前，国际惯例，对于几个常见误解进行声明：

本蛾子热爱中华人民共和国，热爱中国共产党，绝无污蔑、诋毁国家、党和人民的行为，本文的目的仅仅是技术分享，读者您的行为的后果由您自行承担；
本蛾子没有收一分钱；相反，还因为购买服务器和域名花了 30 多，本文请放心食用；
搭建代理服务器是一个比较复杂的过程，您应当有最基本的 Linux 使用能力，对网络相关知识有一定了解；
无论是自建的代理还是机场，总有被封或跑路的一天，您的钱若打了水漂，本蛾子不负责。


12 月 28 日更新：删去了大段大段没啥用的安全性分析。

👌 我知道了，开始吧
准备好了？让我们先看看大概要做什么。

购买 RackNerd 服务器（0x04 节）；
购买 Namesilo 域名并用 Cloudflare 托管（0x04 节）；
服务器初步设置，对于建站比较通用（0x05 节）；
搭建代理服务器，此时您已经可以使用代理了（0x05 节）；
（可选）使用 Cloudflare 的 CDN 和 WARP 服务，对服务器前后流量进行优化（0x06 节）；
（可选）安全性和速度提升（0x06 节）。

本蛾子趁着双十一购买了服务器和域名，总价 27.86（¥200.87，按照支付宝和 Stripe 的汇率），如果您不幸地在没什么活动的时候看到这篇文章，也可以选择到 RackNerd 社区去找找优惠，下面会说到。如果没有什么意外（不可能），搭建时间会在 30 到 40 分钟。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "搭建自己的代理服务器",
      "item": "http://localhost:1313/posts/4f6adc86c6/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "搭建自己的代理服务器",
  "name": "搭建自己的代理服务器",
  "description": "😡 太长不读版：使用 VLESS + WebSocket + TLS 方案、Cloudflare CDN 保护、Cloudflare WARP 解锁服务，在 RackNerd 的 10.99/yr 起廉价服务器上搭建一个安全、隐私、不易封的代理服务器。无广告，很详细。如果您已经下定决心要自己搭建，请跳过 0x01 和 0x02 节。\n本文如未特殊提及，货币单位均为美元。好吧，其实是会被 KaTeX 识别成数学公式……\n各位想必都已经混迹互联网十余载，对于这门技术有所耳闻，甚至自己购买过机场的订阅，在外面的世界已经遨游过一番了。今天本蛾子就讲一个老生常谈的问题：老是觉得那些机场主都不可靠，我能不能自己搭一个？\n首先在文章开始之前，国际惯例，对于几个常见误解进行声明：\n本蛾子热爱中华人民共和国，热爱中国共产党，绝无污蔑、诋毁国家、党和人民的行为，本文的目的仅仅是技术分享，读者您的行为的后果由您自行承担； 本蛾子没有收一分钱；相反，还因为购买服务器和域名花了 30 多，本文请放心食用； 搭建代理服务器是一个比较复杂的过程，您应当有最基本的 Linux 使用能力，对网络相关知识有一定了解； 无论是自建的代理还是机场，总有被封或跑路的一天，您的钱若打了水漂，本蛾子不负责。 12 月 28 日更新：删去了大段大段没啥用的安全性分析。\n👌 我知道了，开始吧 准备好了？让我们先看看大概要做什么。\n购买 RackNerd 服务器（0x04 节）； 购买 Namesilo 域名并用 Cloudflare 托管（0x04 节）； 服务器初步设置，对于建站比较通用（0x05 节）； 搭建代理服务器，此时您已经可以使用代理了（0x05 节）； （可选）使用 Cloudflare 的 CDN 和 WARP 服务，对服务器前后流量进行优化（0x06 节）； （可选）安全性和速度提升（0x06 节）。 本蛾子趁着双十一购买了服务器和域名，总价 27.86（¥200.87，按照支付宝和 Stripe 的汇率），如果您不幸地在没什么活动的时候看到这篇文章，也可以选择到 RackNerd 社区去找找优惠，下面会说到。如果没有什么意外（不可能），搭建时间会在 30 到 40 分钟。\n",
  "keywords": [
    
  ],
  "articleBody": "😡 太长不读版：使用 VLESS + WebSocket + TLS 方案、Cloudflare CDN 保护、Cloudflare WARP 解锁服务，在 RackNerd 的 10.99/yr 起廉价服务器上搭建一个安全、隐私、不易封的代理服务器。无广告，很详细。如果您已经下定决心要自己搭建，请跳过 0x01 和 0x02 节。\n本文如未特殊提及，货币单位均为美元。好吧，其实是会被 KaTeX 识别成数学公式……\n各位想必都已经混迹互联网十余载，对于这门技术有所耳闻，甚至自己购买过机场的订阅，在外面的世界已经遨游过一番了。今天本蛾子就讲一个老生常谈的问题：老是觉得那些机场主都不可靠，我能不能自己搭一个？\n首先在文章开始之前，国际惯例，对于几个常见误解进行声明：\n本蛾子热爱中华人民共和国，热爱中国共产党，绝无污蔑、诋毁国家、党和人民的行为，本文的目的仅仅是技术分享，读者您的行为的后果由您自行承担； 本蛾子没有收一分钱；相反，还因为购买服务器和域名花了 30 多，本文请放心食用； 搭建代理服务器是一个比较复杂的过程，您应当有最基本的 Linux 使用能力，对网络相关知识有一定了解； 无论是自建的代理还是机场，总有被封或跑路的一天，您的钱若打了水漂，本蛾子不负责。 12 月 28 日更新：删去了大段大段没啥用的安全性分析。\n👌 我知道了，开始吧 准备好了？让我们先看看大概要做什么。\n购买 RackNerd 服务器（0x04 节）； 购买 Namesilo 域名并用 Cloudflare 托管（0x04 节）； 服务器初步设置，对于建站比较通用（0x05 节）； 搭建代理服务器，此时您已经可以使用代理了（0x05 节）； （可选）使用 Cloudflare 的 CDN 和 WARP 服务，对服务器前后流量进行优化（0x06 节）； （可选）安全性和速度提升（0x06 节）。 本蛾子趁着双十一购买了服务器和域名，总价 27.86（¥200.87，按照支付宝和 Stripe 的汇率），如果您不幸地在没什么活动的时候看到这篇文章，也可以选择到 RackNerd 社区去找找优惠，下面会说到。如果没有什么意外（不可能），搭建时间会在 30 到 40 分钟。\n💵 花钱 其实本蛾子一直都想哪次出国旅游，把台式机带着，找个角落连上网线和电源，就这么免费享受家宽加上超高性能。当然是瞎想了。\n首先我们来到 RackNerd。活动期间会有首页横幅，点击进入即可。RackNerd 的老板据说是华人，除了北美常见节日有活动，双十一、春节等等国内节日也有，并且优点是续费可以原价。如果有可能的话，就在双十一前后买，这样到期之后重新购买，相当于免费换一个 IP。\n如果没有活动，也可以去 RackNerd 的社区活动，常年有优惠，最低价格 10.99，甚至比这个活动还要低。\n无论如何，我们现在可以选择四个套餐，具体配置大家可以自己看，这里本蛾子推荐：\n如果您没有建站的需要，11.11 套餐足矣。 如果您希望在代理之外做点好玩的（WordPress、游戏服务器等），建议购买 25.98 套餐。 注：这里的价格是按照双十一活动写的，如果您查看的是社区活动，请相应选择第一档和第三档套餐。为啥？主要看以下几个指标：\n🧮 vCPU 和内存：这两个决定了能跑多少服务以及性能，如果只是代理，1 vCPU 加上 1 GiB 内存绰绰有余，但是如果有其他想法，尤其是内存容易捉襟见肘； 🛜 流量和带宽：决定你一个月能用多少流量，最低的 1 TiB 都远超机场了，但是注意这个流量包括您在服务器上下载的内容和发送的内容，也就是说您做代理的的用量会是两倍，如果您要看什么 8K 视频，建议还是选大点的带宽为妙； 💾 硬盘：能存多少东西，RackNerd 是全 SSD 的，本蛾子跑过分，也说明如此，大可放心，至于容量，看您自己的需求； 🗺️ 位置：重点来了，这是我们的场景下最重要的内容之一。RackNerd 只有一处 MC 机房（洛杉矶），其他均为 CC（关于 MC 和 CC 区别请自行搜索），后者有时候会出现谷歌验证码、流媒体封禁的情况，而 11.11 套餐是没有 Los Angles DC-02 选项的！并且洛杉矶有直通中国的电缆，因此速度上会比较好看，丢包也稍微少点，通过 RackNerd 的测试页面来看，前后差距能达到 10 倍！但是 RackNerd 看来是超售了，晚高峰时间段还是会卡顿。 12 月 12 日更新：如果使用了下文所述的 WARP 代理，有一定几率也会跳谷歌验证码，介意的话可以不开 WARP，或者多试几次，找一个好的 IP 用。\n12 月 28 日更新：是 WARP 的锅，由于其默认使用 IPv6，提高了许多站点的敏感度，而且这些 IP 都是万人共用，有追求的话可以购买 WARP+ 或者——换一家 VPS 吧。\n关于地址再多说一点，千万不要为了省几刀去买最便宜的套餐，垃圾线路对速度影响真的很大。如果您已经选择了稍贵一点的线路，也请注意不要选错位置，不然多花的钱就浪费了。\n以下是一个示例，需要注意的地方本蛾子用红框框标注了，大家自查：\n大家应该知道 Ubuntu 并不适用于服务器，但是我们这里还是没有选择企业级 Linux 例如 Rocky Linux，主要有几个原因：\nRocky Linux 9 的 NetworkManager 更新需要手动操作，怕大家不大熟悉 Linux； Rocky Linux 的软件包很旧，有些新的脚本用不了； Rocky Linux 预装了比较麻烦的 SELinux，这是个好东西，但是在我们的情况下比较复杂且易导致错误。 12 月 28 日更新：其实用 Rocky Linux 也可以，文末添加了教程。不知道为什么 Ubuntu 的 SSH 总是一顿一顿的。\n选好了服务器配置，接下来就可以付款了。记得选择支付宝，用手机扫码付款，然后注册一个 RackNerd 账号来管理，这些就不详细说，相信大家是会的。付款之后，您填写的邮箱会收到一封邮件，里面包含了 VPS 的 root 密码，以及他们 NerdVM 管理账号。先不着急去连接，我们再来付钱买个域名。\n域名嘛，我直接推荐大家去 Namesilo 注册一个 .top，江苏的一家公司运营，非常便宜，首年 1.88，续费 4.88，什么 .com 之类的就别奢望了，价格普遍 20+。其实 Spaceship 有一些活动非常诱人，例如 .one 首年只要 0.98，但是次年要 23.98，所以……擦亮眼睛吧。\n接下来，同样注册一个账号，我们直接付款购买。\n域名注册好之后，我们马上会将 DNS 记录转移到 Cloudflare 托管，但是由于 Cloudflare 的域名注册没有 .top 的授权，所以不能彻底转移，后期的续费等操作还是要在 Namesilo 上操作。其实如果你只是想搭建一个代理，可以没有域名，但是为了证书和避免 IP 暴露，我们还是买一个为好。\n打开 Cloudflare，注册之类的工作相信大家都会，就不细说了，完成之后我们看到账户主页就有 Add a domain 的选项，我们点击。\n输入你的域名，并根据提示在 Namesilo 将 DNS 服务器修改为 Cloudflare 提供的两个。要说 Namesilo 的管理界面是真的古旧，算了算了，还是给大家演示一下怎么修改 DNS 记录吧。\n首先，在用户的 Dashboard 上打开域名管理。\n然后选择我们刚刚购买的域名，右侧有一个疑似数据库管理的图标——实际上是 DNS 服务管理。\n然后我们删除原来所有的 DNS 服务器，并添加 Cloudflare 提供的服务器。\n这时候我们回到 Cloudflare（是的，接下来基本可以和 Namesilo 这个丑陋的界面说再见了），等待 Cloudflare 的 DNS 信息更新，过一会儿我们就能看见成功的提示了。\n关于 Cloudflare 服务的用法还有很多（大善人的名号不是白叫的），目前的设置应该够用了，本蛾子过段时间可能再写一篇文章，说说怎么用 Cloudflare 的服务给自己的网站增加安全性。（致各位信奥赛选手：如果您的机房采用了极域、育林卫、（旧版）联想以及很多旧的网络控制系统，让您无法上网（但是可以看到一个阻止页面），那么 DNSSEC 能让您的网站正常使用（防止 DNS 污染）。）\n0x05 建站 现在我们可以翻出刚刚 RackNerd 的那封邮件了。简单阅读一下，最重要的信息是两个：\nIP 地址和用于 SSH 的用户名和密码； NerdVM 账户。 后者我们暂时还是用不到，所以先别着急删除邮件。如果您使用 Windows，打开 PowerShell；如果您使用 Linux——这还需要本蛾子教您吗？总之打开一个现代的终端，几乎所有平台都已经有了 OpenSSH。我们使用以下命令连接：\n$ ssh root@[YOUR_IP_ADDRESS] 嗯……有问题吗？前面那个 $ 不是命令的一部分啦，是说您要用普通用户执行！[YOUR_IP_ADDRESS] 是刚刚看到的 IP 地址！\n本蛾子说过您需要最基本的 Linux 知识。\n如果您是首次连接，那么会出现询问您是否保存指纹的提示，直接输入 yes 即可。然后输入刚刚的 root 密码，密码是不显示的，输完之后直接按回车，如果输出了按住退格一会儿，清空输入，如果干脆不想连接了直接按 Ctrl-C 中止。\n不出意外，一长串信息将会欢迎您：\nWelcome to Ubuntu 22.04.5 LTS (GNU/Linux 5.15.0-125-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/pro System information as of *** System load: *** Processes: *** Usage of /: *** Users logged in: *** Memory usage: *** IPv4 address for eth0: *** Swap usage: *** * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s just raised the bar for easy, resilient and secure K8s cluster deployment. https://ubuntu.com/engage/secure-kubernetes-at-the-edge Expanded Security Maintenance for Applications is not enabled. *** updates can be applied immediately. Enable ESM Apps to receive additional future security updates. See https://ubuntu.com/esm or run: sudo pro status 这段文字里包含了系统信息、版本，当前状态，还有，咳咳，Ubuntu 的广告。\n下面会出现一个您可能很熟悉的东西——刚刚输入 SSH 命令的时候见过？\nroot@racknerd-***:~# 这就是命令提示符了，您后面的命令都需要这样输入。但是现在我们通过 root 登录，还用 SSH，这是非常危险的，所以第一步是建立一个有 sudo 权限的普通账户，并且禁止 root 通过 SSH 登录。\nroot@racknerd-***:~# useradd -m -G sudo admin 添加一个名为 admin 的用户，并分配进入 sudo 组。注意似乎除了 Ubuntu 没人把特权组叫作 sudo，不是都叫 wheel 吗？\nroot@racknerd-***:~# passwd admin New password: Retype new password: passwd: Password updated successfully 在提示输入新密码的地方输入，然后重复一遍。注意仍然是不显示的。\n在修改 SSH 设置之前，我们先测试一下，防止设置有问题，待会儿就没法通过 root 连接服务器了。\nroot@racknerd-***:~# su - admin admin@racknerd-***:~$ 注意到提示符的变化了吗？我们进入了普通用户模式。\nadmin@racknerd-***:~$ sudo apt --version [sudo] password for admin: 输入您刚刚设置的密码，你应该可以看到 APT 的版本信息，但是如果你看到的是：\nadmin is not in the sudoers file. 说明你刚刚的设置存在问题，比如没有加入 sudo 组。\n如果没有什么问题，接下来我们就可以禁用 root 的 SSH 登录了。\nadmin@racknerd-***:~$ sudo vim /etc/ssh/sshd_config 路径名称可以使用 Tab 补全。如果您不会使用 Vim，请自行在网上搜索一下，有很多相关的教程，这里只需要关注两个：\n正常模式（启动时）下输入 i 进入输入模式； 按下 退出输入模式，回到正常模式； 正常模式下输入 / 搜索，回车到达； 结束编辑之后，在正常模式下输入 :wq 退出 Vim 并保存。 很简单吧！我们这里只需要查找到 PermitRootLogin 这个设置，将之后的 yes 修改为 no 就行，然后退出 Vim，并重启 sshd 服务：\nadmin@racknerd-***:~$ sudo systemctl restart sshd 然后输入 exit 并重新用 admin@[YOUR_IP_ADDRESS] 连接，这样您使用的就是普通用户了。\n12 月 28 日更新：如果您想进一步防止 SSH 暴力破解密码，请按使用 SSH 公钥登录服务器并禁用密码的说明操作。\n最基本的事情做完了，接下来我们来更新一下。目前 RackNerd 提供的最新版本是 22.04 LTS，最新的则是 24.04 LTS，您千万不要动心去 do-release-upgrade，主要是因为我们毕竟不在服务器跟前，防止出现什么问题我们无法调试。什么？需要换源吗？开玩笑，我们的服务器可是在美国！\nadmin@racknerd-***:~$ sudo apt update \u0026\u0026 sudo apt upgrade 更新完成，由于我们没有 Live Patch 之类的高科技，还是需要老老实实地重启：\nadmin@racknerd-***~$ sudo reboot 稍等 1 分钟，再次连接，Ubuntu 的软件包就是最新的了！\n接下来，我们就开始代理的搭建了。其实最好是要自己手动搭建，毕竟那些 N 合一的脚本出过一些挂马、挖矿的幺蛾子丑闻，但是这里为了方便（绝对不是本蛾子没搭建成功），我们还是采用一个本蛾子验证过且很有名的脚本：233boy/v2ray，这样一死一大片。\n首先下载脚本：\nwget https://raw.githubusercontent.com/233boy/v2ray/refs/heads/master/install.sh 执行，安装：\nbash install.sh 这时候脚本会直接给出一个链接，但是暂时不要使用，因为它是纯 VLESS，没有加密，没有 CDN，也没有配置我们花费 1.88 巨款买的域名来防止 IP 泄露。我们再次打开面板：\nsudo v2ray change 然后输入 1 更改协议，输入 8 选择 VLESS + WS + TLS。选择 WebSocket 作为加密是因为 Cloudflare CDN 只支持 WS。\n然后便又一次给出一个订阅链接。这个链接其实已经可以使用了，但是建议还是不要连接，否则特征流量太多容易被封。\n我们回到 Cloudflare 将域名（可以是子域名）解析到服务器 IP，注意这时候不要开启小黄云，否则脚本无法验证域名是否能到达服务器。\n再次使用 sudo v2ray change 打开修改面板，选择 3 更改域名，输入上述域名，这时候可以发现给出的订阅链接又有变化，但是依然不要使用。\n再再次使用 sudo v2ray change，我们来换个端口，考虑到大家可能会用服务器来建站，所以我们尽量不要占用 443 端口，而是使用 Cloudflare CDN 支持的端口，根据您的情况，可以修改为：2053，2087，2096 或者 8443。给出的链接依旧不要使用。\n再再再回到 Cloudflare（读者：你有完没完），打开小黄云。好了，你可以使用上一步的代理链接了。\n什么？您手滑把终端 clear 了？这么不小心，肯定和本蛾子没关系。使用 sudo v2ray i 查看配置就行了。\n12 月 28 日更新：如果您不小心把原来的 SSH 公私钥丢了，上述命令能让您在无法显示中文的 VNC 中直接查看订阅信息。\n⚙️ 优化 到这时候我们安全的问题就基本解决了。我们的请求现在是这样的：\n您的客户端发送请求到 Cloudflare 边缘服务器（过墙，HTTPS 加密，常规流量）； Cloudflare 边缘服务器发现 CDN 没有缓存（那肯定的），发送请求到服务器（墙外，TLS 加密，常规流量）； 服务器的 v2ray 接收到请求，将数据包发送回 Cloudflare 边缘服务器（墙外，TLS + WS 加密，VLESS 特征流量）； Cloudflare 边缘服务器将您的数据发送回客户端（过墙，HTTPS + TLS + WS 加密，VLESS 特征流量）。 可以发现，我们的客户端和服务器都只与 Cloudflare 边缘服务器进行通信，本质上和您访问 Cloudflare Dashboard 没有区别。但是还有一点：您的服务器 IP 是 IDC 机房 IP，非常脏，有些流媒体服务无法使用。因此我们可以在服务器端再次部署一个 WARP 代理，使用 Cloudflare 的 IP 获得更好的纯净度。\nwget https://gitlab.com/fscarmen/warp/-/raw/main/menu.sh 接下来，运行脚本：\nbash menu.sh 第一个选项选择 3，剩余的保持默认即可。不出意外，您的服务器将可以连接 WARP 网络，获得一个（大概率）IPv6 地址。恭喜您，最后一块砖，填上了！\n还是很不错的。\n您现在应当可以观看 YouTube+、Disney+ 和 Netflix 非自制剧。如果您是维基人，那么很遗憾，Wikipedia 的编辑还是无法解锁，并且 MediaWiki 不知道有什么魔法，能识别两个 IP，您获得了一个双重封禁！\n12 月 28 日更新：刚刚运行 v2ray 的时候不要着急启动 WARP，这将导致 Caddy 自动获取证书失败。后期如果发现没法连接，也可以回来关掉 WARP，重启 Caddy，获取成功之后再启动。\n✏️ 后记 其实这篇文章到这里还没有结束。服务器管理本身就是很复杂的工作，如果您还想建站，那又是很复杂的工作。您现在想必已经可以自由访问，虽然晚高峰时段部分站点存在卡顿，但是整体还是很不错的。\n最后，提醒您：外网可供您学习、娱乐，但是如果您不是隐私大佬，请不要贸然使用您的任何真实信息和国内身份注册任何服务，或者在网站上发表不当言论。本蛾子是 OIer，外网对本蛾子的吸引力集中在 Stack Overflow、GitHub、Google Scholar 和 Wikipedia，而您，我不知道为啥会想上外网。\n⛰️ 附录：RHEL 系发行版指南 如果您是 RHEL 忠实用户、想使用 SELinux 或者就是不喜欢 Ubuntu，那么本指南的大部分内容依旧适用，有几点需要注意。\n特权组名称为 wheel 而非 sudo。\n如果您计划禁用密码登录，请勿设置 UsePAM no。\n默认启动 firewalld，出于安全考虑，请不要按照网上的教程直接关闭，放行部分端口即可：\n$ sudo firewall-cmd --add-port=2053/tcp --permanent # 2053 改为您在一键脚本里设置的端口号 $ sudo firewall-cmd --add-port=2053/udp --permanent # 别忘了 UDP $ sudo firewall-cmd --reload # 所有未加 --permanent 的规则会失效 SELinux 会阻止 v2ray 使用 443 端口。在做其他事儿的时候也经常会干涉，硬控本蛾子的调试时间。这玩意儿本蛾子也玩不转，据说是 Linux 权限系统的补充，所以还是把它关掉吧：\n$ sudo vim /etc/selinux/config # 将 SELINUX=enforcing 改为 SELINUX=disabled $ sudo reboot # 必须重启 调试 SELinux 导致本蛾子的服务下线时间比 DDoS 还长，于是就自暴自弃了 😮‍💨\n某些额外的包没有预装，按照报错 sudo dnf provides [name] 再 sudo dnf install [name] 即可。\nRackNerd 提供的 Rocky Linux 和 AlmaLinux 首次更新的时候由于 network-scripts 被弃用，会报错，添加 --allowerasing 参数即可。\n12 月 28 日更新：Rocky Linux 更新导致三四个包都出了问题，本蛾子也不能打包票好用。建议转换至 AlmaLinux，处理起来比较简单。\n",
  "wordCount" : "830",
  "inLanguage": "zh-cn",
  "datePublished": "2024-11-17T00:00:00+08:00",
  "dateModified": "2024-11-17T00:00:00+08:00",
  "author":{
    "@type": "Person",
    "name": "智慧的幺蛾子"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/4f6adc86c6/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "桶装幺蛾子",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top"><link rel="stylesheet" href="/js/katex/katex.min.css">
<script defer src="/js/katex/katex.min.js"></script>
<script defer src="/js/katex/contrib/auto-render.js" onload="renderMathInElement(document.body);"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError : false
            });
        });
</script>
<script>
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="🥫 桶装幺蛾子 (Alt + H)">🥫 桶装幺蛾子</a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about" title="❓ 关于">
                    <span>❓ 关于</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives" title="📚 档案">
                    <span>📚 档案</span>
                </a>
            </li>
            <li>
                <a href="https://www.travellings.cn/go.html" title="🚆 开往">
                    <span>🚆 开往</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      搭建自己的代理服务器
    </h1>
    <div class="post-meta"><span title='2024-11-17 00:00:00 +0800 CST'>November 17, 2024</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;智慧的幺蛾子

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#-%e6%88%91%e7%9f%a5%e9%81%93%e4%ba%86%e5%bc%80%e5%a7%8b%e5%90%a7" aria-label="👌 我知道了，开始吧">👌 我知道了，开始吧</a></li>
                <li>
                    <a href="#-%e8%8a%b1%e9%92%b1" aria-label="💵 花钱">💵 花钱</a></li>
                <li>
                    <a href="#0x05-%e5%bb%ba%e7%ab%99" aria-label="0x05 建站">0x05 建站</a></li>
                <li>
                    <a href="#-%e4%bc%98%e5%8c%96" aria-label="⚙️ 优化">⚙️ 优化</a></li>
                <li>
                    <a href="#-%e5%90%8e%e8%ae%b0" aria-label="✏️ 后记">✏️ 后记</a></li>
                <li>
                    <a href="#-%e9%99%84%e5%bd%95rhel-%e7%b3%bb%e5%8f%91%e8%a1%8c%e7%89%88%e6%8c%87%e5%8d%97" aria-label="⛰️ 附录：RHEL 系发行版指南">⛰️ 附录：RHEL 系发行版指南</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>😡 <strong>太长不读版</strong>：使用 VLESS + WebSocket + TLS 方案、Cloudflare CDN 保护、Cloudflare WARP 解锁服务，在 RackNerd 的 10.99/yr 起廉价服务器上搭建一个安全、隐私、不易封的代理服务器。无广告，很详细。如果您已经下定决心要自己搭建，请跳过 0x01 和 0x02 节。</p>
<blockquote>
<p>本文如未特殊提及，货币单位均为美元。好吧，其实是会被 KaTeX 识别成数学公式……</p>
</blockquote>
<p>各位想必都已经混迹互联网十余载，对于这门技术有所耳闻，甚至自己购买过机场的订阅，在外面的世界已经遨游过一番了。今天本蛾子就讲一个老生常谈的问题：<strong>老是觉得那些机场主都不可靠，我能不能自己搭一个？</strong></p>
<p>首先在文章开始之前，国际惯例，对于几个常见误解进行声明：</p>
<ul>
<li>本蛾子<strong>热爱中华人民共和国</strong>，<strong>热爱中国共产党</strong>，<strong>绝无污蔑、诋毁国家、党和人民的行为</strong>，本文的目的仅仅是技术分享，读者您的行为的后果由您自行承担；</li>
<li>本蛾子没有收一分钱；相反，还因为购买服务器和域名花了 30 多，本文请放心食用；</li>
<li>搭建代理服务器是一个比较复杂的过程，您应当有最基本的 Linux 使用能力，对网络相关知识有一定了解；</li>
<li>无论是自建的代理还是机场，总有被封或跑路的一天，您的钱若打了水漂，<strong>本蛾子不负责</strong>。</li>
</ul>
<blockquote>
<p>12 月 28 日更新：删去了大段大段没啥用的安全性分析。</p>
</blockquote>
<h2 id="-我知道了开始吧">👌 我知道了，开始吧<a hidden class="anchor" aria-hidden="true" href="#-我知道了开始吧">#</a></h2>
<p>准备好了？让我们先看看大概要做什么。</p>
<ul>
<li>购买 RackNerd 服务器（0x04 节）；</li>
<li>购买 Namesilo 域名并用 Cloudflare 托管（0x04 节）；</li>
<li>服务器初步设置，对于建站比较通用（0x05 节）；</li>
<li>搭建代理服务器，此时您已经可以使用代理了（0x05 节）；</li>
<li>（可选）使用 Cloudflare 的 CDN 和 WARP 服务，对服务器前后流量进行优化（0x06 节）；</li>
<li>（可选）安全性和速度提升（0x06 节）。</li>
</ul>
<p>本蛾子趁着双十一购买了服务器和域名，总价 27.86（¥200.87，按照支付宝和 Stripe 的汇率），如果您不幸地在没什么活动的时候看到这篇文章，也可以选择到 RackNerd 社区去找找优惠，下面会说到。如果没有什么意外（不可能），搭建时间会在 30 到 40 分钟。</p>
<h2 id="-花钱">💵 花钱<a hidden class="anchor" aria-hidden="true" href="#-花钱">#</a></h2>
<p>其实本蛾子一直都想哪次出国旅游，把台式机带着，找个角落连上网线和电源，就这么免费享受家宽加上超高性能。当然是瞎想了。</p>
<p>首先我们来到 <a href="https://www.racknerd.com">RackNerd</a>。活动期间会有首页横幅，点击进入即可。RackNerd 的老板据说是华人，除了北美常见节日有活动，双十一、春节等等国内节日也有，并且优点是续费可以原价。如果有可能的话，就在双十一前后买，这样到期之后重新购买，相当于免费换一个 IP。</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731406761-image-1024x760.png"></p>
<p>如果没有活动，也可以去 <a href="https://www.racknerd.club">RackNerd 的社区活动</a>，常年有优惠，最低价格 10.99，甚至比这个活动还要低。</p>
<p>无论如何，我们现在可以选择四个套餐，具体配置大家可以自己看，这里本蛾子推荐：</p>
<ul>
<li>如果您没有建站的需要，11.11 套餐足矣。</li>
<li>如果您希望在代理之外做点好玩的（WordPress、游戏服务器等），建议购买 25.98 套餐。</li>
</ul>
<p>注：这里的价格是按照双十一活动写的，如果您查看的是社区活动，请相应选择第一档和第三档套餐。为啥？主要看以下几个指标：</p>
<ul>
<li>🧮 vCPU 和内存：这两个决定了能跑多少服务以及性能，如果只是代理，1 vCPU 加上 1 GiB 内存绰绰有余，但是如果有其他想法，尤其是内存容易捉襟见肘；</li>
<li>🛜 流量和带宽：决定你一个月能用多少流量，最低的 1 TiB 都远超机场了，但是注意这个流量包括您在服务器上下载的内容<strong>和</strong>发送的内容，也就是说您做代理的的用量会是两倍，如果您要看什么 8K 视频，建议还是选大点的带宽为妙；</li>
<li>💾 硬盘：能存多少东西，RackNerd 是全 SSD 的，本蛾子跑过分，也说明如此，大可放心，至于容量，看您自己的需求；</li>
<li>🗺️ <strong>位置</strong>：重点来了，这是我们的场景下最重要的内容之一。RackNerd 只有一处 MC 机房（洛杉矶），其他均为 CC（关于 MC 和 CC 区别请自行搜索），后者有时候会出现谷歌验证码、流媒体封禁的情况，而 11.11 套餐是没有 Los Angles DC-02 选项的！并且洛杉矶有直通中国的电缆，因此速度上会比较好看，丢包也稍微少点，通过 RackNerd 的测试页面来看，前后差距能达到 10 倍！但是 RackNerd 看来是超售了，晚高峰时间段还是会卡顿。</li>
</ul>
<blockquote>
<p>12 月 12 日更新：如果使用了下文所述的 WARP 代理，有一定几率也会跳谷歌验证码，介意的话可以不开 WARP，或者多试几次，找一个好的 IP 用。</p>
<p>12 月 28 日更新：是 WARP 的锅，由于其默认使用 IPv6，提高了许多站点的敏感度，而且这些 IP 都是万人共用，有追求的话可以购买 WARP+ 或者——换一家 VPS 吧。</p>
</blockquote>
<p>关于地址再多说一点，千万不要为了省几刀去买最便宜的套餐，垃圾线路对速度影响真的很大。如果您已经选择了稍贵一点的线路，也请注意不要选错位置，不然多花的钱就浪费了。</p>
<p>以下是一个示例，需要注意的地方本蛾子用红框框标注了，大家自查：</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731408341-image-1024x507.png"></p>
<p>大家应该知道 Ubuntu 并不适用于服务器，但是我们这里还是没有选择企业级 Linux 例如 Rocky Linux，主要有几个原因：</p>
<ul>
<li>Rocky Linux 9 的 NetworkManager 更新需要手动操作，怕大家不大熟悉 Linux；</li>
<li>Rocky Linux 的软件包很旧，有些新的脚本用不了；</li>
<li>Rocky Linux 预装了比较麻烦的 SELinux，这是个好东西，但是在我们的情况下比较复杂且易导致错误。</li>
</ul>
<blockquote>
<p>12 月 28 日更新：其实用 Rocky Linux 也可以，文末添加了教程。不知道为什么 Ubuntu 的 SSH 总是一顿一顿的。</p>
</blockquote>
<p>选好了服务器配置，接下来就可以付款了。记得选择支付宝，用手机扫码付款，然后注册一个 RackNerd 账号来管理，这些就不详细说，相信大家是会的。付款之后，您填写的邮箱会收到一封邮件，里面包含了 VPS 的 root 密码，以及他们 NerdVM 管理账号。先不着急去连接，我们再来付钱买个域名。</p>
<p>域名嘛，我直接推荐大家去 <a href="https://www.namesilo.com/">Namesilo</a> 注册一个 .top，江苏的一家公司运营，非常便宜，首年 1.88，续费 4.88，什么 .com 之类的就别奢望了，价格普遍 20+。其实 <a href="https://www.spaceship.com/">Spaceship</a> 有一些活动非常诱人，例如 .one 首年只要 0.98，但是次年要 23.98，所以……擦亮眼睛吧。</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731409785-image-1024x275.png"></p>
<p>接下来，同样注册一个账号，我们直接付款购买。</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731409836-image-1024x504.png"></p>
<p>域名注册好之后，我们马上会将 DNS 记录转移到 Cloudflare 托管，但是由于 Cloudflare 的域名注册没有 .top 的授权，所以不能彻底转移，后期的续费等操作还是要在 Namesilo 上操作。其实如果你只是想搭建一个代理，可以没有域名，但是为了证书和避免 IP 暴露，我们还是买一个为好。</p>
<p>打开 <a href="https://www.cloudflare.com">Cloudflare</a>，注册之类的工作相信大家都会，就不细说了，完成之后我们看到账户主页就有 Add a domain 的选项，我们点击。</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731759813-image.png"></p>
<p>输入你的域名，并根据提示在 Namesilo 将 DNS 服务器修改为 Cloudflare 提供的两个。要说 Namesilo 的管理界面是真的古旧，算了算了，还是给大家演示一下怎么修改 DNS 记录吧。</p>
<p>首先，在用户的 Dashboard 上打开域名管理。</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731853150-image-1024x780.png"></p>
<p>然后选择我们刚刚购买的域名，右侧有一个疑似数据库管理的图标——实际上是 DNS 服务管理。</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731853271-image-1024x222.png"></p>
<p>然后我们删除原来所有的 DNS 服务器，并添加 Cloudflare 提供的服务器。</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731853392-Screenshot_20241117_222236-1024x564.png"></p>
<p>这时候我们回到 Cloudflare（是的，接下来<strong>基本</strong>可以和 Namesilo 这个丑陋的界面说再见了），等待 Cloudflare 的 DNS 信息更新，过一会儿我们就能看见成功的提示了。</p>
<p>关于 Cloudflare 服务的用法还有很多（大善人的名号不是白叫的），目前的设置应该够用了，本蛾子过段时间可能再写一篇文章，说说怎么用 Cloudflare 的服务给自己的网站增加安全性。（致各位信奥赛选手：如果您的机房采用了极域、育林卫、（旧版）联想以及很多旧的网络控制系统，让您无法上网（但是可以看到一个阻止页面），那么 DNSSEC 能让您的网站正常使用（防止 DNS 污染）。）</p>
<h2 id="0x05-建站">0x05 建站<a hidden class="anchor" aria-hidden="true" href="#0x05-建站">#</a></h2>
<p>现在我们可以翻出刚刚 RackNerd 的那封邮件了。简单阅读一下，最重要的信息是两个：</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731410118-image-1024x978.png"></p>
<ul>
<li>IP 地址和用于 SSH 的用户名和密码；</li>
<li>NerdVM 账户。</li>
</ul>
<p>后者我们暂时还是用不到，所以先别着急删除邮件。如果您使用 Windows，打开 PowerShell；如果您使用 Linux——这还需要本蛾子教您吗？总之打开一个现代的终端，几乎所有平台都已经有了 OpenSSH。我们使用以下命令连接：</p>
<pre tabindex="0"><code>$ ssh root@[YOUR_IP_ADDRESS]
</code></pre><p>嗯……有问题吗？前面那个 <code>$</code> 不是命令的一部分啦，是说您要用普通用户执行！<code>[YOUR_IP_ADDRESS]</code> 是刚刚看到的 IP 地址！</p>
<p>本蛾子说过您需要最基本的 Linux 知识。</p>
<p>如果您是首次连接，那么会出现询问您是否保存指纹的提示，直接输入 <code>yes</code> 即可。然后输入刚刚的 root 密码，密码是不显示的，输完之后直接按回车，如果输出了按住退格一会儿，清空输入，如果干脆不想连接了直接按 Ctrl-C 中止。</p>
<p>不出意外，一长串信息将会欢迎您：</p>
<pre tabindex="0"><code>Welcome to Ubuntu 22.04.5 LTS (GNU/Linux 5.15.0-125-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of ***

  System load:  ***                Processes:             ***
  Usage of /:   ***                Users logged in:       ***
  Memory usage: ***                IPv4 address for eth0: ***
  Swap usage:   ***

 * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s
   just raised the bar for easy, resilient and secure K8s cluster deployment.

   https://ubuntu.com/engage/secure-kubernetes-at-the-edge

Expanded Security Maintenance for Applications is not enabled.

*** updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: sudo pro status
</code></pre><p>这段文字里包含了系统信息、版本，当前状态，还有，咳咳，Ubuntu 的广告。</p>
<p>下面会出现一个您可能很熟悉的东西——刚刚输入 SSH 命令的时候见过？</p>
<pre tabindex="0"><code>root@racknerd-***:~# 
</code></pre><p>这就是命令提示符了，您后面的命令都需要这样输入。但是现在我们通过 root 登录，还用 SSH，这是非常危险的，所以第一步是建立一个有 sudo 权限的普通账户，并且禁止 root 通过 SSH 登录。</p>
<pre tabindex="0"><code>root@racknerd-***:~# useradd -m -G sudo admin
</code></pre><p>添加一个名为 <code>admin</code> 的用户，并分配进入 <code>sudo</code> 组。注意似乎除了 Ubuntu 没人把特权组叫作 <code>sudo</code>，不是都叫 <code>wheel</code> 吗？</p>
<pre tabindex="0"><code>root@racknerd-***:~# passwd admin
New password:
Retype new password:
passwd: Password updated successfully
</code></pre><p>在提示输入新密码的地方输入，然后重复一遍。注意仍然是不显示的。</p>
<p>在修改 SSH 设置之前，我们先测试一下，防止设置有问题，待会儿就没法通过 root 连接服务器了。</p>
<pre tabindex="0"><code>root@racknerd-***:~# su - admin
admin@racknerd-***:~$ 
</code></pre><p>注意到提示符的变化了吗？我们进入了普通用户模式。</p>
<pre tabindex="0"><code>admin@racknerd-***:~$ sudo apt --version
[sudo] password for admin: 
</code></pre><p>输入您刚刚设置的密码，你应该可以看到 APT 的版本信息，但是如果你看到的是：</p>
<pre tabindex="0"><code>admin is not in the sudoers file.
</code></pre><p>说明你刚刚的设置存在问题，比如没有加入 <code>sudo</code> 组。</p>
<p>如果没有什么问题，接下来我们就可以禁用 root 的 SSH 登录了。</p>
<pre tabindex="0"><code>admin@racknerd-***:~$ sudo vim /etc/ssh/sshd_config
</code></pre><p>路径名称可以使用 Tab 补全。如果您不会使用 Vim，请自行在网上搜索一下，有很多相关的教程，这里只需要关注两个：</p>
<ul>
<li>正常模式（启动时）下输入 <code>i</code> 进入输入模式；</li>
<li>按下 <code>&lt;esc&gt;</code> 退出输入模式，回到正常模式；</li>
<li>正常模式下输入 <code>/</code> 搜索，回车到达；</li>
<li>结束编辑之后，在正常模式下输入 <code>:wq</code> 退出 Vim 并保存。</li>
</ul>
<p>很简单吧！我们这里只需要查找到 <code>PermitRootLogin</code> 这个设置，将之后的 <code>yes</code> 修改为 <code>no</code> 就行，然后退出 Vim，并重启 sshd 服务：</p>
<pre tabindex="0"><code>admin@racknerd-***:~$ sudo systemctl restart sshd
</code></pre><p>然后输入 <code>exit</code> 并重新用 <code>admin@[YOUR_IP_ADDRESS]</code> 连接，这样您使用的就是普通用户了。</p>
<blockquote>
<p>12 月 28 日更新：如果您想进一步防止 SSH 暴力破解密码，请按<a href="https://hi.bug-barrel.top/posts/5baaf9322f/">使用 SSH 公钥登录服务器并禁用密码</a>的说明操作。</p>
</blockquote>
<p>最基本的事情做完了，接下来我们来更新一下。目前 RackNerd 提供的最新版本是 22.04 LTS，最新的则是 24.04 LTS，您千万不要动心去 <code>do-release-upgrade</code>，主要是因为我们毕竟不在服务器跟前，防止出现什么问题我们无法调试。什么？需要换源吗？开玩笑，我们的服务器可是在美国！</p>
<pre tabindex="0"><code>admin@racknerd-***:~$ sudo apt update &amp;&amp; sudo apt upgrade
</code></pre><p>更新完成，由于我们没有 Live Patch 之类的高科技，还是需要老老实实地重启：</p>
<pre tabindex="0"><code>admin@racknerd-***~$ sudo reboot
</code></pre><p>稍等 1 分钟，再次连接，Ubuntu 的软件包就是最新的了！</p>
<p>接下来，我们就开始代理的搭建了。其实最好是要自己手动搭建，毕竟那些 N 合一的脚本出过一些挂马、挖矿的<del>幺蛾子</del>丑闻，但是这里为了方便（绝对不是本蛾子没搭建成功），我们还是采用一个本蛾子验证过且很有名的脚本：<a href="https://github.com/233boy/v2ray">233boy/v2ray</a>，<del>这样一死一大片</del>。</p>
<p>首先下载脚本：</p>
<pre tabindex="0"><code>wget https://raw.githubusercontent.com/233boy/v2ray/refs/heads/master/install.sh
</code></pre><p>执行，安装：</p>
<pre tabindex="0"><code>bash install.sh
</code></pre><p>这时候脚本会直接给出一个链接，但是暂时不要使用，因为它是纯 VLESS，没有加密，没有 CDN，也没有配置我们花费 1.88 巨款买的域名来防止 IP 泄露。我们再次打开面板：</p>
<pre tabindex="0"><code>sudo v2ray change
</code></pre><p>然后输入 <code>1</code> 更改协议，输入 <code>8</code> 选择 VLESS + WS + TLS。选择 WebSocket 作为加密是因为 Cloudflare CDN 只支持 WS。</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731854384-image-422x1024.png"></p>
<p>然后便又一次给出一个订阅链接。这个链接其实已经可以使用了，但是建议还是不要连接，否则特征流量太多容易被封。</p>
<p>我们回到 Cloudflare 将域名（可以是子域名）解析到服务器 IP，注意这时候不要开启小黄云，否则脚本无法验证域名是否能到达服务器。</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731855150-image-1024x472.png"></p>
<p>再次使用 <code>sudo v2ray change</code> 打开修改面板，选择 <code>3</code> 更改域名，输入上述域名，这时候可以发现给出的订阅链接又有变化，但是依然不要使用。</p>
<p>再再次使用 <code>sudo v2ray change</code>，我们来换个端口，考虑到大家可能会用服务器来建站，所以我们尽量不要占用 443 端口，而是使用 Cloudflare CDN 支持的端口，根据您的情况，可以修改为：2053，2087，2096 或者 8443。给出的链接依旧不要使用。</p>
<p>再再再回到 Cloudflare（读者：你有完没完），打开小黄云。好了，你可以使用上一步的代理链接了。</p>
<p>什么？您手滑把终端 <code>clear</code> 了？这么不小心，肯定和本蛾子没关系。使用 <code>sudo v2ray i</code> 查看配置就行了。</p>
<blockquote>
<p>12 月 28 日更新：如果您不小心把原来的 SSH 公私钥丢了，上述命令能让您在无法显示中文的 VNC 中直接查看订阅信息。</p>
</blockquote>
<h2 id="-优化">⚙️ 优化<a hidden class="anchor" aria-hidden="true" href="#-优化">#</a></h2>
<p>到这时候我们安全的问题就基本解决了。我们的请求现在是这样的：</p>
<ul>
<li>您的客户端发送请求到 Cloudflare 边缘服务器（过墙，HTTPS 加密，常规流量）；</li>
<li>Cloudflare 边缘服务器发现 CDN 没有缓存（那肯定的），发送请求到服务器（墙外，TLS 加密，常规流量）；</li>
<li>服务器的 v2ray 接收到请求，将数据包发送回 Cloudflare 边缘服务器（墙外，TLS + WS 加密，VLESS 特征流量）；</li>
<li>Cloudflare 边缘服务器将您的数据发送回客户端（过墙，HTTPS + TLS + WS 加密，VLESS 特征流量）。</li>
</ul>
<p>可以发现，我们的客户端和服务器都<strong>只与</strong> Cloudflare 边缘服务器进行通信，本质上和您访问 Cloudflare Dashboard 没有区别。但是还有一点：您的服务器 IP 是 IDC 机房 IP，非常脏，有些流媒体服务无法使用。因此我们可以在服务器端再次部署一个 WARP 代理，使用 Cloudflare 的 IP 获得更好的纯净度。</p>
<pre tabindex="0"><code>wget https://gitlab.com/fscarmen/warp/-/raw/main/menu.sh
</code></pre><p>接下来，运行脚本：</p>
<pre tabindex="0"><code>bash menu.sh
</code></pre><p>第一个选项选择 <code>3</code>，剩余的保持默认即可。不出意外，您的服务器将可以连接 WARP 网络，获得一个（大概率）IPv6 地址。恭喜您，最后一块砖，填上了！</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731856045-image-1024x535.png"></p>
<p>还是很不错的。</p>
<p>您现在应当可以观看 YouTube+、Disney+ 和 Netflix 非自制剧。如果您是维基人，那么很遗憾，Wikipedia 的编辑还是无法解锁，并且 MediaWiki 不知道有什么魔法，能识别两个 IP，您获得了一个双重封禁！</p>
<blockquote>
<p>12 月 28 日更新：刚刚运行 v2ray 的时候不要着急启动 WARP，这将导致 Caddy 自动获取证书失败。后期如果发现没法连接，也可以回来关掉 WARP，重启 Caddy，获取成功之后再启动。</p>
</blockquote>
<h2 id="-后记">✏️ 后记<a hidden class="anchor" aria-hidden="true" href="#-后记">#</a></h2>
<p>其实这篇文章到这里还没有结束。服务器管理本身就是很复杂的工作，如果您还想建站，那又是很复杂的工作。您现在想必已经可以自由访问，虽然晚高峰时段部分站点存在卡顿，但是整体还是很不错的。</p>
<p>最后，提醒您：外网可供您学习、娱乐，但是如果您不是隐私大佬，请不要贸然使用您的任何真实信息和国内身份注册任何服务，或者在网站上发表不当言论。本蛾子是 OIer，外网对本蛾子的吸引力集中在 Stack Overflow、GitHub、Google Scholar 和 Wikipedia，而您，我不知道为啥会想上外网。</p>
<p><img alt="img" loading="lazy" src="../../static/img/4f6adc86c6.d/1731856527-image.png"></p>
<h2 id="-附录rhel-系发行版指南">⛰️ 附录：RHEL 系发行版指南<a hidden class="anchor" aria-hidden="true" href="#-附录rhel-系发行版指南">#</a></h2>
<p>如果您是 RHEL 忠实用户、想使用 SELinux 或者就是不喜欢 Ubuntu，那么本指南的大部分内容依旧适用，有几点需要注意。</p>
<ul>
<li>
<p>特权组名称为 <code>wheel</code> 而非 <code>sudo</code>。</p>
</li>
<li>
<p>如果您计划禁用密码登录，请勿设置 <code>UsePAM no</code>。</p>
</li>
<li>
<p>默认启动 <code>firewalld</code>，出于安全考虑，请不要按照网上的教程直接关闭，放行部分端口即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo firewall-cmd --add-port<span class="o">=</span>2053/tcp --permanent <span class="c1"># 2053 改为您在一键脚本里设置的端口号</span>
</span></span><span class="line"><span class="cl">$ sudo firewall-cmd --add-port<span class="o">=</span>2053/udp --permanent <span class="c1"># 别忘了 UDP</span>
</span></span><span class="line"><span class="cl">$ sudo firewall-cmd --reload <span class="c1"># 所有未加 --permanent 的规则会失效</span>
</span></span></code></pre></div></li>
<li>
<p>SELinux 会阻止 v2ray 使用 443 端口。在做其他事儿的时候也经常会干涉，硬控本蛾子的调试时间。这玩意儿本蛾子也玩不转，据说是 Linux 权限系统的补充，所以还是把它关掉吧：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo vim /etc/selinux/config
</span></span><span class="line"><span class="cl"><span class="c1"># 将 SELINUX=enforcing 改为 SELINUX=disabled</span>
</span></span><span class="line"><span class="cl">$ sudo reboot <span class="c1"># 必须重启</span>
</span></span></code></pre></div><blockquote>
<p>调试 SELinux 导致本蛾子的服务下线时间比 DDoS 还长，于是就自暴自弃了 😮‍💨</p>
</blockquote>
</li>
<li>
<p>某些额外的包没有预装，按照报错 <code>sudo dnf provides [name]</code> 再 <code>sudo dnf install [name]</code> 即可。</p>
</li>
<li>
<p>RackNerd 提供的 Rocky Linux 和 AlmaLinux 首次更新的时候由于 network-scripts 被弃用，会报错，添加 <code>--allowerasing</code> 参数即可。</p>
<blockquote>
<p>12 月 28 日更新：Rocky Linux 更新导致三四个包都出了问题，本蛾子也不能打包票好用。建议转换至 AlmaLinux，处理起来比较简单。</p>
</blockquote>
</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/202b1a70de/">
    <span class="title">« </span>
    <br>
    <span>CF1272E Nearest Opposite Parity 题解</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/976003163f/">
    <span class="title"> »</span>
    <br>
    <span>集训笔记：动态规划经典模型 2</span>
  </a>
</nav>
<img src="/static/img/signature.png">


  </footer>
</article>
    </main>
    
<footer class="footer">
        <span><a href="https://creativecommons.org/public-domain/cc0/">CC0</a> 授权，允许您自由使用。</span>
    <br>
    <span><a href="https://icp.gov.moe/?keyword=20252048" target="_blank">萌ICP备20252048号</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
